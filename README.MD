# Kommo â†” Laburen Integration Middleware â€” V1

**Kommo â†” Laburen Integration Middleware â€” V1** es una integraciÃ³n diseÃ±ada para recibir mensajes entrantes desde **Kommo** mediante *webhooks*, filtrar y procesar Ãºnicamente aquellos provenientes de **WhatsApp**, enviarlos al **Agente de Laburen.com**, y reenviar las respuestas tanto a **Kommo** â€”registrÃ¡ndolas como notas internasâ€” como a **WhatsApp Business API (WABA)**.  

Este servicio actÃºa como un **bridge** (puente de comunicaciÃ³n) entre plataformas, garantizando que los mensajes fluyan de forma **bidireccional**, **segura** y **controlada**, manejando exclusivamente la comunicaciÃ³n basada en **WhatsApp** dentro del ecosistema Kommo.

---

## ğŸš€ CaracterÃ­sticas principales

- Recibe mensajes de **Kommo** mediante webhook, filtrando Ãºnicamente aquellos provenientes de **WhatsApp**.
- Procesa y enruta los mensajes hacia el **Agente de Laburen.com**.
- ReenvÃ­a las respuestas generadas a **Kommo** (como nota interna) y a **WhatsApp Business API (WABA)**.
- Manejo de errores, reintentos y trazabilidad de eventos.
- Compatible con **mensajerÃ­a asincrÃ³nica** y **webhooks seguros**.
- ImplementaciÃ³n modular y extensible, preparada para futuras versiones o integraciÃ³n con nuevas plataformas.

---

## âš™ï¸ Arquitectura general

Kommo â†’ [Webhook Receiver] â†’ [Agente de Laburen.com] â†’ [Kommo (nota) / WhatsApp API]

1. **Kommo Webhook:** envÃ­a los mensajes entrantes.
2. **Kommo â†” Laburen Integration Middleware â€” V1:**
   - Recibe y valida el payload.
   - Filtra Ãºnicamente los mensajes provenientes de **WhatsApp**.
   - EnvÃ­a los mensajes filtrados al **Agente de Laburen.com** para su procesamiento.
3. **Agente de Laburen.com:** genera una respuesta basada en el mensaje recibido.
4. **Middleware:** reenvÃ­a la respuesta hacia **Kommo** (registrÃ¡ndola como nota) y hacia **WhatsApp Business API (WABA)**.

---

## ğŸ§© Endpoints principales

| MÃ©todo | Endpoint   | DescripciÃ³n                           |
| ------ | ---------- | ------------------------------------- |
| `POST` | `/webhook` | Recibe mensajes entrantes desde Kommo |

---

## ğŸ” Variables de entorno

### Laburen
| Variable                | DescripciÃ³n                            |
| ----------------------- | -------------------------------------- |
| `LABUREN_BASE_URL`      | URL base de la API de Laburen.com      |
| `LABUREN_AGENT_ID`      | ID del agente en Laburen.com           |
| `LABUREN_AUTHORIZATION` | Token de autorizaciÃ³n para Laburen.com |

### Kommo
| Variable                    | DescripciÃ³n                       |
| --------------------------- | --------------------------------- |
| `KOMMO_CLIENT_ID`           | ID de cliente en Kommo            |
| `KOMMO_CLIENT_SECRET`       | Secreto de cliente en Kommo       |
| `KOMMO_LONG_DURATION_TOKEN` | Token de larga duraciÃ³n de Kommo  |
| `KOMMO_BASE_URL`            | URL base de la instancia de Kommo |
| `KOMMO_REDIRECT_URI`        | URI de redirecciÃ³n para OAuth     |

### WhatsApp Business API
| Variable              | DescripciÃ³n                                |
| --------------------- | ------------------------------------------ |
| `WPP_API_URL`         | URL de la API de WhatsApp (Graph API)      |
| `WPP_PHONE_NUMBER_ID` | ID del nÃºmero de telÃ©fono de WhatsApp      |
| `WPP_ACCESS_TOKEN`    | Token de acceso para WhatsApp Business API |

---

## ğŸ§° TecnologÃ­as utilizadas

- **Node.js / Express** â€“ Servidor y manejo de rutas.
- **Axios** â€“ Para realizar requests HTTP externos.
- **Dotenv** â€“ GestiÃ³n de variables de entorno.
- **WABA (WhatsApp Business API)** â€“ IntegraciÃ³n con la API de Meta para WhatsApp.
- **Kommo REST API** â€“ ComunicaciÃ³n con el CRM Kommo.

---

## ğŸ§© Estructura del proyecto

src/
â”œâ”€â”€ index.js # Punto de entrada
â”œâ”€â”€ controllers/
â”‚ â””â”€â”€ kommoController.js # LÃ³gica de endpoints de Kommo
â”œâ”€â”€ routes/
â”‚ â””â”€â”€ kommoRoutes.js # Rutas relacionadas con Kommo
â”œâ”€â”€ services/
â”‚ â”œâ”€â”€ kommoService.js # Cliente y lÃ³gica Kommo API
â”‚ â”œâ”€â”€ laburenService.js # LÃ³gica especÃ­fica para Laburen.com
â”‚ â””â”€â”€ wppService.js # Cliente WhatsApp API
â””â”€â”€ utils/
â”œâ”€â”€ normalizer.js # Funciones de normalizaciÃ³n de datos
â”œâ”€â”€ parser.js # Funciones de parsing
â””â”€â”€ rawBody.js # Middleware raw body

---