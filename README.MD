# Kommo ‚Üî Laburen Integration Middleware ‚Äî V1

**Kommo ‚Üî Laburen Integration Middleware ‚Äî V1** es una integraci√≥n dise√±ada para recibir mensajes entrantes desde **Kommo** mediante *webhooks*, filtrar y procesar √∫nicamente aquellos provenientes de **WhatsApp**, enviarlos al **Agente de Laburen.com**, y reenviar las respuestas tanto a **Kommo** ‚Äîregistr√°ndolas como notas internas‚Äî como a **WhatsApp Business API (WABA)**.  

Este servicio act√∫a como un **bridge** (puente de comunicaci√≥n) entre plataformas, garantizando que los mensajes fluyan de forma **bidireccional**, **segura** y **controlada**, manejando exclusivamente la comunicaci√≥n basada en **WhatsApp** dentro del ecosistema Kommo.

---

## üöÄ Caracter√≠sticas principales

- Recibe mensajes de **Kommo** mediante webhook, filtrando √∫nicamente aquellos provenientes de **WhatsApp**.
- Procesa y enruta los mensajes hacia el **Agente de Laburen.com**.
- Reenv√≠a las respuestas generadas a **Kommo** (como nota interna) y a **WhatsApp Business API (WABA)**.
- Manejo de errores, reintentos y trazabilidad de eventos.
- Compatible con **mensajer√≠a asincr√≥nica** y **webhooks seguros**.
- Implementaci√≥n modular y extensible, preparada para futuras versiones o integraci√≥n con nuevas plataformas.

---

## ‚öôÔ∏è Arquitectura general

Kommo ‚Üí [Webhook Receiver] ‚Üí [Agente de Laburen.com] ‚Üí [Kommo (nota) / WhatsApp API]

1. **Kommo Webhook:** env√≠a los mensajes entrantes.
2. **Kommo ‚Üî Laburen Integration Middleware ‚Äî V1:**
   - Recibe y valida el payload.
   - Filtra √∫nicamente los mensajes provenientes de **WhatsApp**.
   - Env√≠a los mensajes filtrados al **Agente de Laburen.com** para su procesamiento.
3. **Agente de Laburen.com:** genera una respuesta basada en el mensaje recibido.
4. **Middleware:** reenv√≠a la respuesta hacia **Kommo** (registr√°ndola como nota) y hacia **WhatsApp Business API (WABA)**.

---

## üß© Endpoints principales

| M√©todo | Endpoint   | Descripci√≥n                           |
| ------ | ---------- | ------------------------------------- |
| `POST` | `/webhook` | Recibe mensajes entrantes desde Kommo |

---

## üßæ Identificadores y Campos Internos

El middleware utiliza distintos **identificadores (IDs)** provenientes de **Kommo** y **Laburen**, que son esenciales para mantener la trazabilidad de los mensajes, las conversaciones y los contactos.  
A continuaci√≥n se explica el uso y prop√≥sito de cada uno.

### üîπ `contact_id`
- **Origen:** Kommo  
- **Descripci√≥n:** ID √∫nico del **contacto** en el CRM Kommo.  
- **Uso:**  
  - Identifica al usuario dentro de Kommo.  
  - Se usa como `visitorId` en Laburen para mantener coherencia entre ambas plataformas.  
  - Es la clave primaria en el `conversationMap` para reusar conversaciones activas.

### üîπ `element_id`
- **Origen:** Kommo  
- **Descripci√≥n:** ID del **lead** (negocio) o elemento principal asociado al contacto.  
- **Uso:**  
  - Permite asociar notas y respuestas dentro del lead correspondiente.  
  - Se utiliza para pausar o reanudar interacciones (`agente pausar` / `agente seguir`).  
  - Sirve como referencia en logs y payloads.

### üîπ `conversationMap`
- **Origen:** Middleware (local)  
- **Descripci√≥n:** Mapa en memoria que asocia `contact_id` ‚Üí `conversationId` de Laburen.  
- **Uso:**  
  - Evita crear m√∫ltiples conversaciones en Laburen para el mismo contacto.  
  - Permite continuar el contexto conversacional.

### üîπ `idsPausados`
- **Origen:** Middleware (local)  
- **Descripci√≥n:** Set en memoria que mantiene los `element_id` (leads) pausados.  
- **Uso:**  
  - Si un lead est√° en este set, los mensajes **no se env√≠an a Laburen**.  
  - Controlado por los comandos:  
    - `"agente pausar"` ‚Üí agrega el `element_id` al set.  
    - `"agente seguir"` ‚Üí lo elimina.

---

## üîê Variables de entorno

### Laburen.com
| Variable                | Descripci√≥n                            |
| ----------------------- | -------------------------------------- |
| `LABUREN_BASE_URL`      | URL base de la API de Laburen.com      |
| `LABUREN_AGENT_ID`      | ID del agente en Laburen.com           |
| `LABUREN_AUTHORIZATION` | Token de autorizaci√≥n para Laburen.com |

### Kommo
| Variable                    | Descripci√≥n                       |
| --------------------------- | --------------------------------- |
| `KOMMO_CLIENT_ID`           | ID de cliente en Kommo            |
| `KOMMO_CLIENT_SECRET`       | Secreto de cliente en Kommo       |
| `KOMMO_LONG_DURATION_TOKEN` | Token de larga duraci√≥n de Kommo  |
| `KOMMO_BASE_URL`            | URL base de la instancia de Kommo |
| `KOMMO_REDIRECT_URI`        | URI de redirecci√≥n para OAuth     |

### WhatsApp Business API
| Variable              | Descripci√≥n                                |
| --------------------- | ------------------------------------------ |
| `WPP_API_URL`         | URL de la API de WhatsApp (Graph API)      |
| `WPP_PHONE_NUMBER_ID` | ID del n√∫mero de tel√©fono de WhatsApp      |
| `WPP_ACCESS_TOKEN`    | Token de acceso para WhatsApp Business API |

---

## üß∞ Tecnolog√≠as utilizadas

- **Node.js / Express** ‚Äì Servidor y manejo de rutas.
- **Axios** ‚Äì Para realizar requests HTTP externos.
- **Dotenv** ‚Äì Gesti√≥n de variables de entorno.
- **WABA (WhatsApp Business API)** ‚Äì Integraci√≥n con la API de Meta para WhatsApp.
- **Kommo REST API** ‚Äì Comunicaci√≥n con el CRM Kommo.

---

## üß© Estructura del proyecto

- **src/**
  - `index.js` ‚Äî Punto de entrada
  - **controllers/**
    - `kommoController.js` ‚Äî L√≥gica de endpoints de Kommo
  - **routes/**
    - `kommoRoutes.js` ‚Äî Rutas relacionadas con Kommo
  - **services/**
    - `kommoService.js` ‚Äî Cliente y l√≥gica Kommo API
    - `laburenService.js` ‚Äî L√≥gica espec√≠fica para Laburen.com
    - `wppService.js` ‚Äî Cliente WhatsApp API
  - **utils/**
    - `normalizer.js` ‚Äî Funciones de normalizaci√≥n de datos
    - `parser.js` ‚Äî Funciones de parsing
    - `rawBody.js` ‚Äî Middleware raw body